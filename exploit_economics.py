from __future__ import annotations

from pydantic import BaseModel, Field


class LiquiditySource(BaseModel):
    source: str
    available_usd: float = Field(ge=0.0)


class EconomicInput(BaseModel):
    estimated_stolen_value_usd: float = Field(gt=0.0)
    required_capital_usd: float = Field(ge=0.0)
    estimated_gas_units: int = Field(gt=0)
    gas_price_gwei: float = Field(gt=0.0)
    eth_price_usd: float = Field(gt=0.0)
    liquidity_sources: list[LiquiditySource] = Field(default_factory=list)


class EconomicAssessment(BaseModel):
    flash_loan_available: bool
    available_flash_loan_usd: float = Field(ge=0.0)
    gas_cost_usd: float = Field(ge=0.0)
    projected_profit_usd: float
    profitable: bool
    viable: bool
    notes: str


def estimate_flash_loan_capacity(liquidity_sources: list[LiquiditySource]) -> float:
    return float(sum(source.available_usd for source in liquidity_sources))


def estimate_gas_cost_usd(estimated_gas_units: int, gas_price_gwei: float, eth_price_usd: float) -> float:
    gas_price_eth = gas_price_gwei * 1e-9
    return estimated_gas_units * gas_price_eth * eth_price_usd


def assess_exploit_economics(payload: EconomicInput) -> EconomicAssessment:
    available = estimate_flash_loan_capacity(payload.liquidity_sources)
    flash_loan_available = available >= payload.required_capital_usd
    gas_cost = estimate_gas_cost_usd(payload.estimated_gas_units, payload.gas_price_gwei, payload.eth_price_usd)
    projected_profit = payload.estimated_stolen_value_usd - gas_cost

    profitable = projected_profit > 0
    viable = flash_loan_available and profitable

    if viable:
        notes = "Scenario is economically viable under current assumptions."
    elif not flash_loan_available:
        notes = "Required capital exceeds modeled flash-loan liquidity."
    else:
        notes = "Gas and execution costs exceed modeled value at risk."

    return EconomicAssessment(
        flash_loan_available=flash_loan_available,
        available_flash_loan_usd=available,
        gas_cost_usd=gas_cost,
        projected_profit_usd=projected_profit,
        profitable=profitable,
        viable=viable,
        notes=notes,
    )